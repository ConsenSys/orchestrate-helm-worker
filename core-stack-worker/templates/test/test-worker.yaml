---
apiVersion: v1
kind: Pod
metadata:
  name: {{ template "core-stack-worker.fullname" . }}-test
  annotations:
    "helm.sh/hook": "test-success"
spec:
  {{ if .Values.imageCredentials }}
  imagePullSecrets:
    - name: {{ template "core-stack-worker.imagePullSecretNameTest" . }}
  {{ end }}
  containers:
  - name: "{{ template "core-stack-worker.fullname" . }}-test"
    image: "{{ .Values.testImage.repository }}:{{ .Values.testImage.tag }}"
    command:
      - /go/bin/main
    args:
      - {{ .Values.testImage.cmd }}
      - run
    envFrom:
      - configMapRef:
          name: {{ include "core-stack-worker.fullname" . }}-envmap
    env:
      # Add env variables only for helm test
      {{- range $key, $value := .Values.testEnvironment }}
      - name: {{ $key }}
        value:  {{ $value | quote }}
      {{- end }}
  restartPolicy: Never
